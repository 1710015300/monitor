<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status de Conexão</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">

    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-online { background-color: #22c55e; /* green-500 */ }
        .status-offline { background-color: #ef4444; /* red-500 */ }
        .status-checking {
            background-color: #f59e0b; /* amber-500 */
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2337; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Animação de Flash para o Refresh */
        @keyframes flash {
            0%, 100% { background-color: #1f2937; } /* bg-gray-800 */
            50% { background-color: #374151; } /* bg-gray-700 */
        }
        .is-checking-animation {
            animation: flash 0.8s ease-in-out;
        }

        .status-tick {
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 6px;
            vertical-align: text-bottom;
            color: #22c55e; /* green-500 */
        }
    </style>
</head>
<body class="text-white">

    <div class="container mx-auto max-w-2xl p-4 md:p-6 relative">

        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-100">Status de Conexão</h1>
            <p class="text-gray-400 mt-1">Verificação em tempo real da saúde dos serviços.</p>
        </header>

        <div class="absolute top-4 right-4 flex items-center gap-2">
            <button id="refresh-btn" class="flex items-center gap-2 bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold p-2 rounded-md transition-colors duration-300 text-sm disabled:opacity-50 disabled:cursor-wait" title="Atualizar">
                <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
            </button>
             <div class="relative">
                <button id="options-btn" class="p-2 bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold rounded-md transition-colors duration-300" title="Opções">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16">
                        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                    </svg>
                </button>
                <div id="options-menu" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 z-20">
                    <a href="#" id="show-quick-test-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Teste Rápido</a>
                    <a href="#" id="show-history-btn" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Histórico</a>
                </div>
            </div>
        </div>
        
        <main id="services-container" class="space-y-3">
            </main>
    </div>

    <div id="quick-test-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 transform -translate-y-10">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Teste Rápido de URL</h2>
                <button class="close-modal-btn text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <form id="quick-test-form">
                <div class="flex items-center gap-3">
                    <input type="text" id="quick-test-url" placeholder="URL (ex: irapuru.com.br)" class="flex-grow bg-gray-700 text-white placeholder-gray-400 rounded-md px-3 py-2 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-300">OK</button>
                </div>
            </form>
             <div id="quick-test-result-container" class="mt-4"></div>
        </div>
    </div>
    
    <div id="history-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 transform -translate-y-10">
             <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Últimos Eventos (24h)</h2>
                <button class="close-modal-btn text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="max-h-96 overflow-y-auto text-sm">
                <table class="w-full">
                    <tbody id="history-log">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos da UI ---
            const servicesContainer = document.getElementById('services-container');
            const historyLog = document.getElementById('history-log');
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshIcon = document.getElementById('refresh-icon');
            const optionsBtn = document.getElementById('options-btn');
            const optionsMenu = document.getElementById('options-menu');
            
            // --- Elementos dos Modais ---
            const quickTestModal = document.getElementById('quick-test-modal');
            const historyModal = document.getElementById('history-modal');
            const showQuickTestBtn = document.getElementById('show-quick-test-btn');
            const showHistoryBtn = document.getElementById('show-history-btn');
            const quickTestForm = document.getElementById('quick-test-form');
            const quickTestUrlInput = document.getElementById('quick-test-url');
            const quickTestResultContainer = document.getElementById('quick-test-result-container');

            const CHECK_INTERVAL = 30000;

            // --- ESTADO DA APLICAÇÃO ---
            const webAccessService = { name: 'Acesso Web', type: 'web-access', urls: ['https://8.8.8.8', 'https://1.1.1.1'], status: 'checking', showTick: false };
            const apisulService = { name: 'Apisul', type: 'url', urls: ['https://1.1.1.1'], status: 'checking' };
            const metadadosService = { name: 'Metadados', type: 'url', urls: ['https://1.1.1.1'], status: 'checking' };
            const urmoboService = { name: 'Urmobo', type: 'url', urls: ['https://1.1.1.1'], status: 'checking' };
            let services = [webAccessService, apisulService, metadadosService, urmoboService]; // Lista de serviços fixos
            let history = JSON.parse(localStorage.getItem('statusHistory')) || [];

            // --- FUNÇÕES DE PERSISTÊNCIA ---
            const saveHistory = () => localStorage.setItem('statusHistory', JSON.stringify(history.filter(e => e.timestamp > Date.now() - 86400000)));
            
            const addHistoryEvent = (serviceName, status) => {
                const now = new Date();
                const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const statusText = status === 'offline' ? 'Indisponibilidade' : 'Normalização';
                const message = `${statusText} no ${serviceName} às ${time}`;
                history.unshift({ message, status, timestamp: now.getTime() });
                saveHistory();
                renderHistory();
            }

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            const renderServices = () => {
                const tickSVG = `<svg class="status-tick" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.35 2.35 4.493-6.74a.75.75 0 0 1 1.04-.208Z" clip-rule="evenodd" /></svg>`;
                servicesContainer.innerHTML = '';
                services.forEach((service, index) => {
                    const statusClass = `status-${service.status}`;
                    const statusText = service.status.charAt(0).toUpperCase() + service.status.slice(1);
                    const serviceDiv = document.createElement('div');
                    serviceDiv.className = 'service-item bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between';
                    
                    let subText = service.status === 'online' ? 'Serviço operacional.' : (service.status === 'offline' ? 'Serviço inacessível.' : 'Verificando...');
                    if (service.type === 'web-access') {
                        subText = service.status === 'online' ? 'Você está conectado à Internet.' : (service.status === 'offline' ? 'Você parece estar sem conexão.' : 'Verificando conexão...');
                    }
                    let statusDisplay = service.showTick ? statusText + tickSVG : statusText;
                    
                    serviceDiv.innerHTML = `<div class="flex items-center"><span class="status-dot ${statusClass} mr-3"></span><div><p class="font-semibold text-gray-100">${service.name}</p><p class="text-sm text-gray-400">${subText}</p></div></div><span class="font-medium text-sm text-gray-300 flex items-center">${statusDisplay}</span>`;
                    servicesContainer.appendChild(serviceDiv);
                });
            };

            const renderHistory = () => {
                historyLog.innerHTML = history.length === 0 ? `<tr><td class="text-gray-400 py-2 text-center">Nenhum evento registrado.</td></tr>` : '';
                history.forEach(event => {
                    const statusColorClass = event.status === 'online' ? 'status-online' : 'status-offline';
                    const logEntry = document.createElement('tr');
                    logEntry.className = 'border-b border-gray-700/50 last:border-b-0';
                    logEntry.innerHTML = `<td class="py-2 px-1 w-4"><span class="status-dot ${statusColorClass}"></span></td><td class="py-2 text-gray-300">${event.message}</td>`;
                    historyLog.appendChild(logEntry);
                });
            };

            // --- LÓGICA DE VERIFICAÇÃO ---
            const checkStatus = async (service, index) => {
                const currentStatus = service.status;
                let newStatus = 'offline';
                
                const checkSingleUrl = (url) => new Promise(async (resolve) => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    try { 
                        const response = await fetch(`${url}?t=${Date.now()}`, { mode: 'no-cors', signal: controller.signal });
                        resolve(true); 
                    } catch (error) { 
                        resolve(false); 
                    } finally { 
                        clearTimeout(timeoutId); 
                    }
                });
                
                if (service.type === 'web-access') {
                    const results = await Promise.all(service.urls.map(checkSingleUrl));
                    if (results.some(isOnline => isOnline)) newStatus = 'online';
                } else {
                    const isOnline = await checkSingleUrl(service.urls[0]);
                    if (isOnline) newStatus = 'online';
                }
                
                if (currentStatus !== newStatus) {
                    services[index].status = newStatus;
                    if (currentStatus !== 'checking') addHistoryEvent(service.name, newStatus);
                    renderServices();
                }
            };

            const runAllChecks = async (isManual = false) => {
                refreshBtn.disabled = true;
                refreshIcon.classList.add('animate-spin');
                
                if (isManual) {
                    const serviceItems = servicesContainer.querySelectorAll('.service-item');
                    serviceItems.forEach(item => item.classList.add('is-checking-animation'));
                }

                await Promise.all(services.map((service, index) => checkStatus(service, index)));
                
                if (isManual) {
                    services.forEach(s => { if (s.status === 'online') s.showTick = true; });
                    renderServices();
                    setTimeout(() => {
                        services.forEach(s => s.showTick = false);
                        renderServices();
                    }, 2000);
                }

                setTimeout(() => {
                    if (isManual) {
                        const serviceItems = servicesContainer.querySelectorAll('.service-item');
                        serviceItems.forEach(item => item.classList.remove('is-checking-animation'));
                    }
                    refreshIcon.classList.remove('animate-spin');
                    refreshBtn.disabled = false;
                }, 800);
            };

            // --- LÓGICA DE MODAIS E MENUS ---
            const toggleModal = (modal, show) => {
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        modal.querySelector('.modal-content').classList.remove('-translate-y-10');
                    }, 10);
                } else {
                    modal.classList.add('opacity-0');
                    modal.querySelector('.modal-content').classList.add('-translate-y-10');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            };
            
            const resetQuickTestModal = () => {
                quickTestResultContainer.innerHTML = '';
                quickTestForm.reset();
            };

            optionsBtn.addEventListener('click', (e) => { e.stopPropagation(); optionsMenu.classList.toggle('hidden'); });
            document.addEventListener('click', () => optionsMenu.classList.add('hidden'));
            showQuickTestBtn.addEventListener('click', (e) => { e.preventDefault(); toggleModal(quickTestModal, true); });
            showHistoryBtn.addEventListener('click', (e) => { e.preventDefault(); toggleModal(historyModal, true); });
            
            document.querySelectorAll('.modal-backdrop, .close-modal-btn').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (e.target === el) {
                        toggleModal(quickTestModal, false);
                        toggleModal(historyModal, false);
                        resetQuickTestModal();
                    }
                });
            });

            // --- EVENT LISTENERS ---
            quickTestForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                let url = quickTestUrlInput.value.trim();
                if (!url) return;
                
                if (!url.startsWith('http')) {
                    url = 'https://' + url;
                }

                quickTestResultContainer.innerHTML = `<p class="text-center text-gray-400">Testando...</p>`;
                
                let status = 'offline';
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                try {
                    await fetch(`${url}?t=${Date.now()}`, { mode: 'no-cors', signal: controller.signal });
                    status = 'online';
                } catch (error) {
                    status = 'offline';
                } finally {
                    clearTimeout(timeoutId);
                }
                
                const statusClass = `status-${status}`;
                const statusText = status === 'online' ? 'Online' : 'Offline';
                const subText = status === 'online' ? `O site está acessível.` : `Não foi possível conectar.`;

                quickTestResultContainer.innerHTML = `
                    <div class="bg-gray-700 p-4 rounded-lg flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="status-dot ${statusClass} mr-3"></span>
                            <div>
                                <p class="font-semibold text-gray-100 break-all">${quickTestUrlInput.value}</p>
                                <p class="text-sm text-gray-400">${subText}</p>
                            </div>
                        </div>
                        <span class="font-medium text-sm text-gray-300">${statusText}</span>
                    </div>
                `;
            });

            refreshBtn.addEventListener('click', () => runAllChecks(true));

            // --- INICIALIZAÇÃO ---
            renderServices();
            renderHistory();
            runAllChecks();
            setInterval(runAllChecks, CHECK_INTERVAL);
        });
    </script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').then(registration => {
            console.log('ServiceWorker registrado com sucesso: ', registration.scope);
          }, err => {
            console.log('Registro do ServiceWorker falhou: ', err);
          });
        });
      }
    </script>
</body>
</html>
